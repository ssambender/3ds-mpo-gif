<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>3DS Wigglegram</title>
    <link rel="stylesheet" href="style.css">
    <link rel="icon" href="icon.png">
</head>
<body>

<div id="backgroundTex"></div>
<div id="vignette"></div>
<div id="background2" style="display: none;">
    <div id="backgroundYellow"></div>
    <div id="backgroundStars"></div>
</div>

<div id="creditsBottom">
    <a href="https://sambender.net" target="_blank">Sam Bender 2024</a>
</div>

<!-- INSTRUCTIONS MODAL -->
<div id="instructionsModal">
    <div class="mainPopup shadow">
        <div class="mainText" style="margin-bottom: 20px">
            Instructions:<br>
        </div>
        <div id="instructionsContainer">
            <div class="instructStep">
                <div class="mainInstruction">
                    <img src="step1.png">
                    <div class="explain">
                        Take photos on 3DS as normal, or locate previously taken photos. Try to keep the camera as horizontal as possible for best results!
                    </div>
                </div>
                <div style="padding-top: 6px; opacity: 65%;">
                    Optional: Enable the camera level by pressing down on the D-PAD
                </div>
            </div>
            <div class="instructDivider"></div>
            <div class="instructStep">
                <div class="mainInstruction">
                    <img src="step2.png">
                    <div class="explain">
                        If not already on the SD card, save the photos to the SD card. Load the images onto your computer or phone either by SD card or FTP.
                    </div>
                </div>
                <div style="padding-top: 6px; opacity: 65%;">
                    (Photos can be found in the DCIM folder)
                </div>
            </div>
            <div class="instructDivider"></div>
            <div class="instructStep">
                <div class="mainInstruction">
                    <img src="step3.png">
                    <div class="explain">
                        On the website, open the .MPO file. Drag the adjustment slider until the focal point of your image is as black as it can be. Pick frame length ms.
                    </div>
                </div>
            </div>
            <div class="instructDivider"></div>
            <div class="instructStep">
                <div class="mainInstruction">
                    <img src="step4.png">
                    <div class="explain">
                        View & Download your wigglegram as a GIF with the respective buttons. Frame length time can be changed here as well to your liking.
                    </div>
                </div>
            </div>
        </div>

        <div class="buttonsContainer">
            <button id="closeInstructionsBtn" type="button" class="modal-action" onclick="closeInstructions()">
                <div class="modal-action-pattern"></div>
                <div class="modal-action-fade"></div>
                <span class="modal-action-text inter-font" style="text-transform: uppercase;">Got it!</span>
            </button>
        </div>
    </div>
</div>

<!-- IMAGE UPLOAD BUTTON -->
<div id="initialModal">
    <div class="mainPopup shadow">
        <div class="mainText">
            3DS Wigglegram Maker from .MPO<br>

            <div class="subText">
                Upload an <b>.mpo</b> image taken from a 3DS (or other stereoscopic device) and magically receive a wigglegram GIF!
            </div>
        </div>
        <div class="buttonsContainer">
            <button id="upload-mpo-btn" type="button" class="modal-action" onclick="triggerFileUpload()">
                <div class="modal-action-pattern"></div>
                <div class="modal-action-fade"></div>
                <span class="modal-action-text inter-font" style="text-transform: uppercase;">Upload .MPO File</span>
            </button>

            <div class="buttonsRow2">
                <button type="button" class="modal-action" onclick="window.open('https://github.com/ssambender/3ds-mpo-gif');">
                    <div class="modal-action-pattern"></div>
                    <div class="modal-action-fade"></div>
                    <span class="modal-action-text inter-font">View GitHub</span>
                </button>

                <button type="button" class="modal-action" onclick="openInstructions()">
                    <div class="modal-action-pattern"></div>
                    <div class="modal-action-fade"></div>
                    <span class="modal-action-text inter-font">Instructions / Guide</span>
                </button>
            </div>
        </div>
    </div>
</div>
<input id="imageUpload" type="file" accept=".mpo" onchange='loadImg(event)' style="display: none;">

<!-- SPLIT L/R IMAGES (HIDDEN) -->
<div style="display:none;">
    <canvas id="canvas_left" width="640px" height="480px" style="border: solid 2px blue;"></canvas>
    <canvas id="canvas_right" width="640px" height="480px" style="border: solid 2px red;"></canvas>
</div>


<div id="secondScreenContainer">
    <div id="secondScreenModal" class="shadow">
        <!-- ADJUSTMENT SLIDER -->
        <div id="differenceLabel">
            Adjust the slider below so that main subject is the most black it can be.
        </div>
        <div id="differenceControl">
            <input id="adjustOverlap" type="range" min="-320" max="320" style="width: 500px"><span id="adjustAmountLabel">0px</span>
        </div>
        <!-- ADJUSTMENT OVERLAY IMAGES -->
        <div id="differenceContainer">
            <canvas id="canvas_overlap" width="640px" height="480px"></canvas>
            <canvas id="canvas_bottom" width="640px" height="480px"></canvas>
        </div>
        <!-- FRAME LENGTH -->
        <div id="frameLengthContainer">
            <span style="margin-right: 4px">Optional: Change frame length ms:</span>
            <input id="frameSpeed" type="number" value="100" min="50" max="250" step="10">
        </div>

        <!-- CREATE GIF BUTTON -->
        <div id="createGifContainer" style="padding: 20px 0; display: flex; justify-content: center;">
            <button type="button" class="modal-action" onclick="viewGif()">
                <div class="modal-action-pattern"></div>
                <div class="modal-action-fade"></div>
                <span class="modal-action-text inter-font">CREATE GIF</span>
            </button>
        </div>
    </div>

    <div id="viewGifModal" class="shadow" style="display: none;">
        <div id="viewGIF">
            <img id="finalGif">
        </div>

        <button type="button" class="modal-action" onclick="downloadGif()">
            <div class="modal-action-pattern"></div>
            <div class="modal-action-fade"></div>
            <span class="modal-action-text inter-font">DOWNLOAD GIF</span>
        </button>


        <a onclick="makeAnother();">MAKE ANOTHER!</a>
    </div>
</div>


<!-- CROPPED FRAMES (HIDDEN) -->
<div style="display: none">
    <canvas id="canvas_cropped1" width="960px" height="480px" style="border: solid 2px black;"></canvas><br>
    <canvas id="canvas_cropped2" width="960px" height="480px" style="border: solid 2px black;"></canvas><br>
    <canvas id="canvas_cropped3" width="960px" height="480px" style="border: solid 2px black;"></canvas><br>
</div>

<!-- FINAL GIF -->

<script>

    // TODO - fix custom cursor after file upload

    // TODO - add "Learn More" screen

    // TODO - make end screen look nicer

    window.onbeforeunload = null;  // prevent page reload confirmation

    function triggerFileUpload() {
        document.getElementById('imageUpload').click();
    }

    /* https://github.com/k-hatano/stereo_viewer_js */
    var canvasWidth = 640;
    var canvasHeight = 480;

    let imageName = "";
    let overlayOffset = 0;
    let frameSpeed = 100;

    var leftImage = new Image();
    var rightImage = new Image();

    onload = function() {
        drawCanvas();
    };

    function loadImg(event) {
        console.log("loadimg()");
        var file = event.target.files[0];
        var reader = new FileReader();
        reader.readAsBinaryString(file);

        reader.onload = function() {
            imageName = file.name.toString().split('.')[0];
            let result = splitImageToLeftRight(reader.result);

            // todo - wait for the result before setting the src (below) instead of waiting a length/time

            leftImage.src = result[1];
            rightImage.src = result[0];

            setTimeout(function(){
                drawCanvas();

                document.getElementById('secondScreenContainer').style.display = 'flex';
                document.getElementById('background2').style.display = "flex";
                //document.getElementById('differenceControl').style.display = 'flex';
                //document.getElementById('differenceContainer').style.display = 'flex';
                //document.getElementById('frameLengthContainer').style.display = 'flex';
                //document.getElementById('differenceLabel').style.display = 'flex';
                //document.getElementById('createGifContainer').style.display = 'flex';

                window.onbeforeunload = function(e) {return 'Reload page? Progress will not be saved';};  // page reload confirmation
            }, 234);

            document.getElementById('initialModal').style.display = 'none';
        };
    }

    function drawCanvas() {
        var canvasLeft = document.getElementById('canvas_left');
        var contextLeft = canvasLeft.getContext('2d');
        contextLeft.drawImage(leftImage, 0, 0, canvasWidth, canvasHeight);

        var canvasRight = document.getElementById('canvas_right');
        var contextRight = canvasRight.getContext('2d');
        contextRight.drawImage(rightImage, 0, 0, canvasWidth, canvasHeight);

        var canvasBottom = document.getElementById('canvas_bottom');
        var contextBottom = canvasBottom.getContext('2d');
        contextBottom.drawImage(leftImage, 0, 0, canvasWidth, canvasHeight);

        var canvasOverlap = document.getElementById('canvas_overlap');
        var contextOverlap = canvasOverlap.getContext('2d');
        contextOverlap.drawImage(rightImage, 0, 0, canvasWidth, canvasHeight);
    }

    function splitImageToLeftRight(source) {
        var indexPair = [];
        var depth = 0;
        var startIndex = 0;

        for (var i = 0; i < source.length; i++) {

            if (source.charCodeAt(i) === 0xff && source.charCodeAt(i + 1) === 0xd8) {
                if (depth === 0) {
                    startIndex = i;
                }
                depth++;
                i++;
            }
            if (source.charCodeAt(i) === 0xff && source.charCodeAt(i + 1) === 0xd9) {
                depth--;
                if (depth === 0) {
                    indexPair.push({start:startIndex, end:i + 2});
                }
                i++;
            }
        }

        var result = [];
        for (var j = 0; j < indexPair.length; j++) {
            var image = source.substring(indexPair[j].start, indexPair[j].end);
            var imageUrl = 'data:image/jpeg;base64,' + btoa(image);

            result.push(imageUrl);
        }
        return result;
    }

    document.getElementById('adjustOverlap').addEventListener("input", function() {
        document.getElementById("canvas_overlap").style.marginLeft = document.getElementById('adjustOverlap').value.toString() + "px";
        document.getElementById("canvas_overlap").style.paddingLeft = document.getElementById('adjustOverlap').value.toString() + "px";
        document.getElementById('adjustAmountLabel').innerText = document.getElementById('adjustOverlap').value.toString() + "px";
        overlayOffset = document.getElementById('adjustOverlap').value;
    }, false);

    document.getElementById('frameSpeed').addEventListener("input", function() {
        frameSpeed = document.getElementById('frameSpeed').value;
    }, false);


    function createFrames() {
        var frame_crop1 = document.getElementById('canvas_cropped1');
        var frame_crop2 = document.getElementById('canvas_cropped2');
        var frame_crop3 = document.getElementById('canvas_cropped3');
        let crop_width;
        if(overlayOffset > 0){
            crop_width = (160 + canvasWidth) - (160 + parseInt(overlayOffset));
        }
        else {
            crop_width = (160 + canvasWidth + parseInt(overlayOffset)) - 160;
        }
        frame_crop1.width = crop_width;
        frame_crop2.width = crop_width;
        frame_crop3.width = crop_width;


        var ctx_crop1 = frame_crop1.getContext('2d');
        ctx_crop1.clearRect(0, 0, crop_width, canvasHeight);  //parseInt(overlayOffset)
        ctx_crop1.drawImage(leftImage, 0 - parseInt(overlayOffset), 0, canvasWidth, canvasHeight);

        var ctx_crop2 = frame_crop2.getContext('2d');
        ctx_crop2.clearRect(0, 0, crop_width, canvasHeight);
        ctx_crop2.globalAlpha = 1;
        ctx_crop2.drawImage(leftImage, 0 - parseInt(overlayOffset), 0, canvasWidth, canvasHeight);
        ctx_crop2.globalAlpha = 0.5;
        ctx_crop2.drawImage(rightImage, 0, 0, canvasWidth, canvasHeight);

        var ctx_crop3 = frame_crop3.getContext('2d');
        ctx_crop3.clearRect(0, 0, crop_width, canvasHeight);
        ctx_crop3.drawImage(rightImage, 0, 0, canvasWidth, canvasHeight);

        var encoder = new GIFEncoder();
        encoder.setRepeat(0);
        encoder.setDelay(parseInt(frameSpeed));
        encoder.start();
        encoder.addFrame(ctx_crop1);
        encoder.addFrame(ctx_crop2);
        encoder.addFrame(ctx_crop3);
        encoder.addFrame(ctx_crop2);
        encoder.finish();

        //encoder.download(imageName + "_wigglegram_" + frameSpeed.toString() + "ms.gif");

        var binary_gif = encoder.stream().getData()
        var data_url = 'data:image/gif;base64,'+encode64(binary_gif);
        document.getElementById('finalGif').src = data_url;
    }

    function viewGif() {
        createFrames();
        document.getElementById('viewGIF').style.display = 'flex';
        document.getElementById('viewGifModal').style.display = 'flex';
        document.getElementById('secondScreenModal').style.display = 'none';
    }

    function downloadGif() {
        createFrames();

        var gifSrc = document.getElementById('finalGif').src;

        var downloadLink = document.createElement('a');
        downloadLink.href = gifSrc;
        downloadLink.download = imageName + "_wigglegram_" + frameSpeed.toString() + ".gif";
        document.body.appendChild(downloadLink);
        downloadLink.click();
        document.body.removeChild(downloadLink);
    }

    function makeAnother() {
        window.onbeforeunload = null;  // prevent page reload confirmation
        location.reload();
    }

    function openInstructions() {
        document.getElementById('instructionsModal').style.display = 'flex';
        document.getElementById('initialModal').style.display = 'none';
    }
    function closeInstructions() {
        document.getElementById('instructionsModal').style.display = 'none';
        document.getElementById('initialModal').style.display = 'flex';
    }
</script>

<script type="text/javascript" src="LZWEncoder.js"></script>
<script type="text/javascript" src="NeuQuant.js"></script>
<script type="text/javascript" src="GIFEncoder.js"></script>
<script type="text/javascript" src="b64.js"></script>

</body>
</html>
