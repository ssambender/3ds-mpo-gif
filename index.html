<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>3DS Wigglegram</title>
    <link rel="stylesheet" href="style.css">
    <link rel="icon" href="icon.png">
</head>
<body>

<div id="stripe-container">
    <div id="stripe-pattern"></div>
</div>

<!-- IMAGE UPLOAD BUTTON -->
<div id="initialModal">
    <div id="mainPopup">
        <div id="mainText">
            3DS Wigglegram Maker from .MPO<br>

            <div id="subText">
                Upload an <b>.mpo</b> image taken from a 3DS (or other stereoscopic device) and magically receive a wigglegram GIF!
            </div>
        </div>
        <div id="buttonsContainer">
            <button id="upload-mpo-btn" type="button" class="modal-action" onclick="triggerFileUpload()">
                <div class="modal-action-pattern"></div>
                <div class="modal-action-fade"></div>
                <span class="modal-action-text inter-font" style="text-transform: uppercase;">Upload .MPO File</span>
            </button>

            <div id="buttonsRow2">
                <button type="button" class="modal-action" onclick="window.open('https://github.com/ssambender/3ds-mpo-gif');">
                    <div class="modal-action-pattern"></div>
                    <div class="modal-action-fade"></div>
                    <span class="modal-action-text inter-font">View GitHub</span>
                </button>

                <button type="button" class="modal-action">
                    <div class="modal-action-pattern"></div>
                    <div class="modal-action-fade"></div>
                    <span class="modal-action-text inter-font">Learn More</span>
                </button>
            </div>
        </div>
    </div>
</div>
<input id="imageUpload" type="file" accept=".mpo" onchange='loadImg(event)' style="display: none;">

<!-- SPLIT L/R IMAGES (HIDDEN) -->
<div style="display:none;">
    <canvas id="canvas_left" width="640px" height="480px" style="border: solid 2px blue;"></canvas>
    <canvas id="canvas_right" width="640px" height="480px" style="border: solid 2px red;"></canvas>
</div>

<!-- ADJUSTMENT SLIDER -->
<div id="differenceLabel">
    Adjust the slider below so that subject/pivot point is the most black it can be.
</div>
<div id="differenceControl">
    <input id="adjustOverlap" type="range" min="-320" max="320" style="width: 500px"><span id="adjustAmountLabel">0px</span>
</div>
<!-- ADJUSTMENT OVERLAY IMAGES -->
<div id="differenceContainer">
    <canvas id="canvas_overlap" width="640px" height="480px"></canvas>
    <canvas id="canvas_bottom" width="640px" height="480px"></canvas>
</div>
<!-- FRAME LENGTH -->
<div id="frameLengthContainer">
    <span style="margin-right: 4px">Frame length ms:</span>
    <input id="frameSpeed" type="number" value="100" min="50" max="250" step="10">
</div>

<!-- CREATE GIF BUTTON -->
<div id="createGifContainer" style="background-color: rgba(0,0,0,0.85); padding: 20px 0; display: none; justify-content: center;">
    <button type="button" class="modal-action" onclick="viewGif()">
        <div class="modal-action-pattern"></div>
        <div class="modal-action-fade"></div>
        <span class="modal-action-text inter-font">VIEW GIF</span>
    </button>

    <button type="button" class="modal-action" onclick="downloadGif()">
        <div class="modal-action-pattern"></div>
        <div class="modal-action-fade"></div>
        <span class="modal-action-text inter-font">DOWNLOAD GIF</span>
    </button>
</div>

<!-- CROPPED FRAMES (HIDDEN) -->
<div style="display: none">
    <canvas id="canvas_cropped1" width="960px" height="480px" style="border: solid 2px black;"></canvas><br>
    <canvas id="canvas_cropped2" width="960px" height="480px" style="border: solid 2px black;"></canvas><br>
    <canvas id="canvas_cropped3" width="960px" height="480px" style="border: solid 2px black;"></canvas><br>
</div>

<!-- FINAL GIF -->
<div id="viewGIF">
    <img id="finalGif">
</div>


</div>

<script>

    // TODO - fix custom cursor after file upload

    // TODO - add "Learn More" screen

    // TODO - make end screen look nicer & add "another file" button

    function triggerFileUpload() {
        document.getElementById('imageUpload').click();
    }

    /* https://github.com/k-hatano/stereo_viewer_js */
    var canvasWidth = 640;
    var canvasHeight = 480;

    let imageName = "";
    let overlayOffset = 0;
    let frameSpeed = 100;

    var leftImage = new Image();
    var rightImage = new Image();

    onload = function() {
        drawCanvas();
    };

    function loadImg(event) {
        var file = event.target.files[0];
        var reader = new FileReader();
        reader.readAsBinaryString(file);

        reader.onload = function() {
            imageName = file.name.toString().split('.')[0];
            let result = splitImageToLeftRight(reader.result);

            //wait for the result before setting the src (below)

            leftImage.src = result[1];
            rightImage.src = result[0];

            setTimeout(function(){
                drawCanvas();

                document.getElementById('differenceControl').style.display = 'flex';
                document.getElementById('differenceContainer').style.display = 'flex';
                document.getElementById('frameLengthContainer').style.display = 'flex';
                document.getElementById('differenceLabel').style.display = 'flex';
                document.getElementById('createGifContainer').style.display = 'flex';
            }, 234);

            document.getElementById('initialModal').style.display = 'none';
        };
    }

    function drawCanvas() {
        var canvasLeft = document.getElementById('canvas_left');
        var contextLeft = canvasLeft.getContext('2d');
        contextLeft.drawImage(leftImage, 0, 0, canvasWidth, canvasHeight);

        var canvasRight = document.getElementById('canvas_right');
        var contextRight = canvasRight.getContext('2d');
        contextRight.drawImage(rightImage, 0, 0, canvasWidth, canvasHeight);

        var canvasBottom = document.getElementById('canvas_bottom');
        var contextBottom = canvasBottom.getContext('2d');
        contextBottom.drawImage(leftImage, 0, 0, canvasWidth, canvasHeight);

        var canvasOverlap = document.getElementById('canvas_overlap');
        var contextOverlap = canvasOverlap.getContext('2d');
        contextOverlap.drawImage(rightImage, 0, 0, canvasWidth, canvasHeight);
    }

    function splitImageToLeftRight(source) {
        var indexPair = [];
        var depth = 0;
        var startIndex = 0;

        for (var i = 0; i < source.length; i++) {

            if (source.charCodeAt(i) === 0xff && source.charCodeAt(i + 1) === 0xd8) {
                if (depth === 0) {
                    startIndex = i;
                }
                depth++;
                i++;
            }
            if (source.charCodeAt(i) === 0xff && source.charCodeAt(i + 1) === 0xd9) {
                depth--;
                if (depth === 0) {
                    indexPair.push({start:startIndex, end:i + 2});
                }
                i++;
            }
        }

        var result = [];
        for (var j = 0; j < indexPair.length; j++) {
            var image = source.substring(indexPair[j].start, indexPair[j].end);
            var imageUrl = 'data:image/jpeg;base64,' + btoa(image);

            result.push(imageUrl);
        }
        return result;
    }

    document.getElementById('adjustOverlap').addEventListener("input", function() {
        document.getElementById("canvas_overlap").style.marginLeft = document.getElementById('adjustOverlap').value.toString() + "px";
        document.getElementById("canvas_overlap").style.paddingLeft = document.getElementById('adjustOverlap').value.toString() + "px";
        document.getElementById('adjustAmountLabel').innerText = document.getElementById('adjustOverlap').value.toString() + "px";
        overlayOffset = document.getElementById('adjustOverlap').value;
    }, false);

    document.getElementById('frameSpeed').addEventListener("input", function() {
        frameSpeed = document.getElementById('frameSpeed').value;
    }, false);


    function createFrames() {
        // cropped
        var frame_crop1 = document.getElementById('canvas_cropped1');
        var frame_crop2 = document.getElementById('canvas_cropped2');
        var frame_crop3 = document.getElementById('canvas_cropped3');
        let crop_width = canvasWidth;
        if(overlayOffset > 0){
            crop_width = (160 + canvasWidth) - (160 + parseInt(overlayOffset));
        }
        else {
            crop_width = (160 + canvasWidth + parseInt(overlayOffset)) - 160;
        }
        frame_crop1.width = crop_width;
        frame_crop2.width = crop_width;
        frame_crop3.width = crop_width;


        // todo - fix below, when overlapping image goes over the edge to the left
        var ctx_crop1 = frame_crop1.getContext('2d');
        ctx_crop1.clearRect(0, 0, crop_width, canvasHeight);  //parseInt(overlayOffset)
        ctx_crop1.drawImage(leftImage, 0 - parseInt(overlayOffset), 0, canvasWidth, canvasHeight);

        var ctx_crop2 = frame_crop2.getContext('2d');
        ctx_crop2.clearRect(0, 0, crop_width, canvasHeight);
        ctx_crop2.globalAlpha = 1;
        ctx_crop2.drawImage(leftImage, 0 - parseInt(overlayOffset), 0, canvasWidth, canvasHeight);
        ctx_crop2.globalAlpha = 0.5;
        ctx_crop2.drawImage(rightImage, 0, 0, canvasWidth, canvasHeight);

        var ctx_crop3 = frame_crop3.getContext('2d');
        ctx_crop3.clearRect(0, 0, crop_width, canvasHeight);
        ctx_crop3.drawImage(rightImage, 0, 0, canvasWidth, canvasHeight);

        // create gif from canvas 2d contexts
        var encoder = new GIFEncoder();
        encoder.setRepeat(0);
        encoder.setDelay(parseInt(frameSpeed)); //go to next frame every n milliseconds
        encoder.start();
        encoder.addFrame(ctx_crop1);
        encoder.addFrame(ctx_crop2);
        encoder.addFrame(ctx_crop3);
        encoder.addFrame(ctx_crop2);
        encoder.finish();

        // download GIF
        //encoder.download(imageName + "_wigglegram_" + frameSpeed.toString() + "ms.gif");

        // view GIF
        var binary_gif = encoder.stream().getData() //notice this is different from the as3gif package!
        var data_url = 'data:image/gif;base64,'+encode64(binary_gif);
        document.getElementById('finalGif').src = data_url;
    }

    function viewGif() {
        createFrames();
        document.getElementById('viewGIF').style.display = 'flex';
    }

    function downloadGif() {
        createFrames();

        // Get the data URL of the final GIF image
        var gifSrc = document.getElementById('finalGif').src;

        // Create a temporary anchor element
        var downloadLink = document.createElement('a');
        downloadLink.href = gifSrc;
        downloadLink.download = imageName + "_wigglegram_" + frameSpeed.toString() + ".gif";

        // Append the anchor to the body (required for Firefox)
        document.body.appendChild(downloadLink);

        // Trigger the download by simulating a click
        downloadLink.click();

        // Remove the anchor from the body
        document.body.removeChild(downloadLink);
    }
</script>

<script type="text/javascript" src="LZWEncoder.js"></script>
<script type="text/javascript" src="NeuQuant.js"></script>
<script type="text/javascript" src="GIFEncoder.js"></script>
<script type="text/javascript" src="b64.js"></script>

</body>
</html>
